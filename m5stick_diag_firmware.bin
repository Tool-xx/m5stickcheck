# main.py для прошивки
import gc, machine, esp32
from machine import Pin, I2C
import uos
import utime
import m5stack

# Инициализация экрана
lcd = m5stack.Display()
lcd.clear()

# Инициализация I2C для батареи
i2c = I2C(0, scl=Pin(22), sda=Pin(21))

def show(text, y):
    lcd.text(10, y, text, lcd.WHITE)

while True:
    # Получаем данные
    cpu = machine.freq() // 1000000
    free = gc.mem_free()
    total = free + gc.mem_alloc()
    temp = esp32.raw_temperature()
    
    # Чтение батареи
    try:
        vbat = (i2c.readfrom_mem(0x34, 0x78, 2)[0] << 4 | i2c.readfrom_mem(0x34, 0x78, 2)[1]
        vbat = vbat * 1.1 / 1000
    except:
        vbat = 0.0
    
    # Вывод на экран
    lcd.clear()
    show(f"CPU: {cpu}MHz", 10)
    show(f"RAM: {free}/{total}", 30)
    show(f"BAT: {vbat:.2f}V", 50)
    show(f"TEMP: {temp}F", 70)
    
    utime.sleep(2)
